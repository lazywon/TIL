## 현황 정리

- Flask 에서 기본적으로 동시 접속 제한 기능 제공하지 않음. FlaskLogin에서도 동일 사용자가 여러 세션에서 동시에 로그인하는 것을 허용하기 때문에 추가 구현이 필요하다.
- Flask-Session 확장 모듈 사용하여 세션 데이터 저장하고, Flask-Login을 이용하여 사용자 인증 구현
  - _Flask-Login_
    - 로그인, 로그아웃 기능 지원
      - login_user()
        - 로그인 처리를 하고 user 인증 정보 세션에 저장
        - 로그인 성공 이후 사용자 정보를 session에서 검색하여 현재 로그인 된 사용자를 파악
          - @login_required 데코레이터 제공 - 로그인 되지 않은 사용자 접근 제한
          - current_user 함수 제공 - 현재 로그인 된 사용자 객체 얻기 가능
      - logout_user()
        - 현재 세션에서 사용자 정보 삭제하고, 로그인 페이지로 리다이렉션
    - 사용자 모델 클래스 구현 필요
      - Flask-Login이 제공하는 UserMixin 클래스를 상속받아 구현하는 것이 일반적
  - _Flask-Session_
    - 세션 데이터를 SQLAlchemy 파이썬 ORM 라이브러리 사용하여 세션 객체 생성 및 세션 데이터 DB 저장
    - 일반적으로 Flask-Session에서 정의한 sessions 테이블의 기본 필드. 변경, 확장 가능하다.
      - id: 세션 ID
      - data: 세션 데이터
      - expiration: 세션 만료 시간 (30분으로 설정)
    - Flask-Session은 Flask-Login과 독립적으로 작동
      - 클라이언트가 웹 애플리케이션에 접속할 때마다 클라이언트의 세션을 생성 -> 로그아웃 할때 기존 세션이 만료되므로, 새로운 세션이 생성되는게 맞는 것.

## 조치 방법

- 동작 순서
  - 변경 전
    1. 로그인 페이지 진입
    2. Flask-Session에서 세션 객체 생성 및 SQLAlchemy 세션 데이터 저장
    3. Flask-Login에서 사용자 인증 수행
    4. 만료 시간이 도래하기 전까지는 서로 다른 브라우저에서 동일 id로 무제한 접근 가능
  - 변경 후
    1. (사전 작업) sessions 테이블에 user_id 칼럼 추가
    2. 로그인 페이지 진입
    3. Flask-Session에서 세션 객체 생성 및 SQLAlchemy 세션 데이터 저장 (이때, user_id = NULL로 들어가 있음)
    4. 현재 세션 user_id를 현재 사용자 id로 DB UPDATE
    5. 동일 ID 동시 접속 중인 세션을 확인 (expiry > now 로 활성 세션 이면서 현재 로그인한 user_id이면서, 현재 세션이 아닌 것 조회)
       1. 만약 동시 접속중인 세션 존재 시 해당 세션 만료 시킴 -> 새로운 요청 시 로그아웃 페이지로 리다이렉트
    6. 현재 세션으로 Flask-Login에서 사용자 인증 수행
- 오류 났었던 원인과 회고 😥
  - 플라스크 세션과 로그인 내부 동작 방식에 대해 정확히 파악하지 않고 개발 진행
    - 세션이 DB에 저장되는 순서를 flask_login 이후라고 생각하여 로직 설계를 잘 못함
  - (핑계아닌 핑계) - DB 방화벽 문제로 테스트하며 파악할 수 없어 보다 시간이 오래 걸렸던것 같다 !!
  - 정확한 동작 방식에 대해 미리 공부하자 !
- 추가로 알아두면 좋은 것 !
  - BeakerCache 사용하여 세션 데이터 캐시로 저장하여 사용할 수 있음.
    - 하지만, 현재 모델 정의만 되어있고 실제로 사용중이지는 않음.
    - session 테이블에 있는 정보를 더 빨리 가져오기 위함으로 사용하지만, 백오피스에서 속도 차이가 크지 않아 사용할 필요성을 느끼지 못함.
